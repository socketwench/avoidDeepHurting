<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Avoid Deep Hurting! Deployment beyond git</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/cowsay.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <section>
            <h1>Avoid</h1>
            <h1 class="deep-hurting">DEEP HURTING!</h1>
            <p>Deployments beyond git</p>
            <p>&nbsp;</p>
            <small>use &larr;&uarr;&darr;&rarr; or &lt;SPACE&gt;</small>
          </section>
          <section>
            <pre style="font-size:1em;">
      _________________
    /                   \
    |  Time to deploy!  |
    \                   /
      -----------------
             \   ^__^
              \  (oo)\_______
                 (__)\       )\/\
                     ||----w |
                     ||     ||
            </pre>
          </section>
        </section>

				<section>
          <section data-transition="none">
            <img src="images/socketwench1.png" />
          </section>
          <section data-transition="none">
            <img src="images/socketwench2.png" />
          </section>
          <section data-transition="none">
            <img src="images/socketwench3.png" />
          </section>
					<section data-transition="none">
            <img src="images/socketwench4.png" />
          </section>
					<section data-transition="none">
            <img src="images/socketwench5.png" />
          </section>
          <section>
            <p>TEN7 marketing slide</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Deploying Drupal: A history</h1>
          </section>
          <section>
            <h2>Remember...</h2>
            <p class="fragment">FTP&gt; <span class="blink_me">&block;</span></p>
          </section>
          <section>
            <h2>FTP frustrations</h2>
            <p class="fragment">Insecure!</p>
            <p class="fragment">Permissions and modes</p>
            <p class="fragment">Often the only option available</p>
          </section>
          <section>
            <h2>And then git came along...</h2>
          </section>
          <section style="text-align: left;">
            <p>ssh gitlover@savemefromftp.now</p>
            <p class="fragment">cd /where/my/awesome/site/is</p>
            <p class="fragment">git pull <span class="blink_me">&block;</span></p>
          </section>
          <section>
            <h2>Post-pull tasks are manual</h2>
            <p>Updating the database, clearing cache</p>
            <p>Could be done through web UI, but not recommended</p>
          </section>
          <section>
            <pre style="font-size:1em;">
      ___________________
    /                     \
    |  But that wasn't    |
    |  the whole story... |
    \                     /
      -------------------
             \   ^__^
              \  (><)\_______
                 (__)\       )\/\
                     ||----w |
                     ||     ||
            </pre>
          </section>
          <section style="text-align: left;">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p class="fragment"><code>cd /where/my/awesome/site/is</code></p>
            <p class="fragment"><code>git pull</code></p>
            <p class="fragment"><code>drush fra -y</code></p>
            <p class="fragment"><code>compass compile -e production --force</code></p>
            <p class="fragment"><code>drush updb -y</code></p>
            <p class="fragment"><code>drush cc all</code></p>
          </section>
          <section style="text-align: left;">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/drupal/8/site/is</code></p>
            <p class="fragment"><code>git pull</code></p>
            <p class="fragment"><code>composer update</code></p>
            <p class="fragment"><code>drush cim -y</code></p>
            <p class="fragment"><code>compass compile -e production --force</code></p>
            <p class="fragment"><code>drush updb -y</code></p>
            <p class="fragment"><code>drush cr all</code></p>
          </section>
          <section>
            <h2>What about...?</h2>
            <p class="fragment">Grunt tasks</p>
            <p class="fragment">Third party integrations</p>
            <p class="fragment">Clearing opcache</p>
            <p class="fragment">Varnish ban</p>
          </section>
          <section data-background="images/deepHurting.gif" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <pre style="font-size:1em;">
      ___________________
    /                     \
    |  And that's when    |
    |  things go well...  |
    \                     /
      -------------------
             \   ^__^
              \  (XX)\_______
                 (__)\       )\/\
                     ||----w |
                     ||     ||
            </pre>
          </section>
          <section>
            <h2>What can go wrong?</h2>
            <p class="fragment">Missed .gitignore's</p>
            <p class="fragment"><code>chmod -R 777 all/the/things</code></p>
            <p class="fragment">Need to rollback!</p>
          </section>
          <!-- Maybe replace this with something less branded? -->
          <section data-background="images/endlessSuffering.gif" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>Humans are fallible</h2>
            <p class="fragment">Good docs don't remove human hands</p>
            <p class="fragment">Typos, missed steps can kill a deploy</p>
          </section>
          <section>
            <h2>Git alone isn't enough</h2>
            <p class="fragment">It's a code history tool...</p>
            <p class="fragment">...not a deployment tool</p>
          </section>
        </section>

        <section>
          <section>
            <h1>So let's use a script!</h1>
          </section>
          <!-- Some kind of comic here -->
          <section>
            <h2>Solves <em>some</em> problems</h2>
            <p class="fragment">Runs all steps the same each time</p>
            <small class="fragment">(Kinda.)</small>
          </section>
          <section>
            <h2>Reduces operator errors</h2>
            <p class="fragment">Just run the script, and your done!</p>
            <p class="fragment">...right?</p>
          </section>
          <section>
            <h2>Writing scripts is painful</h2>
            <p class="fragment">Obscure UNIXisms</p>
            <p class="fragment">Odd programming conventions</p>
            <p class="fragment">Can be as complex as application code</p>
          </section>
          <!-- COMIC
               Developer in the corner, small rubber duck appears opposite.
               "Awww, it's just a little script."
               More ducks appear.
               Developer gets nervous.
               Even more ducks appear.
               "Ummmm..."
               Developer eaten alive by pile of ducks
             -->
          <section>
            <h2>Side effects and repeatability</h2>
            <p class="fragment">Running the same script twice...</p>
            <p class="fragment">...doesn't produce the same results</p>
          </section>
          <section>
            <h2>No idempotence</h2>
            <p>Litters scripts with <code>if</code>s and <code>elsif</code>s</p>
          </section>
          <section>
            <h2>Scripts aren't a solution</h2>
            <p>They are code, not configuration.</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Config Management</h1>
          </section>
          <!-- Some kind of comic here, probably. -->
          <section>
            <h2>Ansible</h2>
            <p>"Radically simple" IT Automation</p>
            <p>Open Source on <a href="https://github.com/ansible/ansible">Github</a></p>
          </section>
          <section>
            <h2>Less dependencies</h2>
            <p>Python 2</p>
            <p>Works on (most) shared hosts</p>
          </section>
          <section>
            <p><code>apt-get install ansible</code></p>
            <p class="fragment"><code>brew install ansible</code></p>
            <p class="fragment"><code>pip install ansible</code></p>
          </section>
          <section>
            <h2>Python MySQL</h2>
            <code>pip install MySQL-python</code>
            <p>Needed for Ansible to work with DBs</p>
          </section>
          <section>
            <h2>Agentless</h2>
            <p class="fragment">Nothing to install on target systems</p>
            <p class="fragment">Uses SSH and Public Keys</p>
            <p class="fragment"><a href="https://www.linode.com/docs/security/use-public-key-authentication-with-ssh">Tutorial on Linode docs</a></p>
          </section>
          <section>
            <h2>Serverless</h2>
            <p class="fragment">No central puppetmaster server</p>
            <p class="fragment">Whatever runs ansible is the controller</p>
          </section>
          <section>
            <h2>Specifying targets</h2>
            <p class="fragment">Inventory files</p>
            <p class="fragment">Text file of IPs/Hostnames</p>
          </section>
          <section>
            <pre>
172.52.52.0
172.52.52.1
172.52.52.2
            </pre><pre class="fragment">
[live]
www.example.com
            </pre><pre class="fragment">
[self]
localhost ansible_connection=local
            </pre>
          </section>
          <section>
            <h2>Easy to read</h2>
            <p class="fragment">Code is YAML <em>playbooks</em></p>
            <p class="fragment">Run top-down, no complex server model</p>
          </section>
          <section>
            <pre>
---
- hosts: all
  vars:
    heyLook: "A variable!"
  tasks:
    - name: Make some stuff happen
            </pre>
          </section>
          <section>
            <h2>Batteries included</h2>
            <p class="fragment">Modules provide functionality</p>
            <p class="fragment">All official modules included</p>
          </section>
          <section>
            <pre>
---
- hosts: all
  vars:
    git_dir: "/home/tess/git"
  tasks:
    - name: Clone repo
      git:
        repo: git@github.com:socketwench/avoidDeepHurting.git
        dest: "{{ git_dir }}"
        clone: yes
        update: yes
        version: "develop"
            </pre>
          </section>
          <section>
            <h2>Idemnopent</h2>
            <p class="fragment">Playbooks describe desired end state</p>
            <p class="fragment">Leaves complex <code>if</code>/<code>else</code> logic to modules</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Fixing git deploy</h1>
          </section>
          <!-- COMIC
            Ends on realization that throwing the web directory away is the
            solution.
           -->
          <!-- COMIC
            Important directories
            Git repo
            web directory (pointed to by apache)
            wip (where builds happen)
          -->
           <section>
             <h2>No more .gitignore hell</h2>
             <p>"Artefacts" no longer in repo</p>
             <p>File directory, compiled SASS, etc.</p>
           </section>
           <section>
             <h2>Ready before Go-live</h2>
             <p>Key assets created before switchover</p>
             <p>"Zero downtime" deployments</p>
           </section>
           <section>
             <pre>
- name: Assure the build directory exists.
  file:
    path: "{{ build_dir }}"
    state: directory
    mode: "0755"
    group: "www-data"
            </pre>
          </section>
          <section>
            <pre>
- name: Copy web files from the repo.
  synchronize:
    src: "{{ web_dir }}/"
    dest: "{{ build_dir }}"
    delete: yes
             </pre>
           </section>
           <section>
             <pre>
- name: Symlink the files directory.
  file:
    src: "{{ files_dir }}"
    dest: "{{ web_dir }}/sites/default/files"
    state: link
    mode: "0775"
             </pre>
           </section>
           <section>
             <pre>
- name: Out with the old...
  shell: "mv {{ web_dir }} {{ web_dir }}_old"
  args:
    creates: "{{ web_dir }}_old"
    removes: "{{ web_dir }}"
</pre><pre class="fragment">
- name: ...in with the new.
  shell: "mv {{ build_dir }} {{ web_dir }}"
  args:
    creates: "{{ web_dir }}"
    removes: "{{ build_dir }}"
              </pre>
            </section>
            <section>
              <h2>Capistrano style builds</h2>
              <p>Timestamp-named build directories</p>
              <p class="fragment"><code>current</code> symlink used as web directory</p>
            </section>
            <!-- COMIC? -->
            <section>
              <h2>Problems</h2>
              <p class="fragment">OpCache refresh must be forced</p>
              <p class="fragment">Autoloaders can become confused</p>
            </section>
            <section>
              <h2>Post Go-live Tasks</h2>
              <p class="fragment">Feature revert or Config Sync import</p>
              <p class="fragment">Database update</p>
              <p class="fragment">Cache clear</p>
            </section>
            <section>
              <pre>
- name: Feature revert (Drupal 7)
  shell: "drush fra -y"
  args:
    chdir: "{{ web_dir }}"
              </pre>
              <pre class="fragment">
- name: Config sync import (Drupal 8)
  shell: "drush cex -y"
  args:
    chdir: "{{ web_dir }}"
              </pre>
            </section>
            <section>
              <pre>
- name: Update database
  shell: "drush updb -y"
  args:
    chdir: "{{ web_dir }}"
              </pre>
            </section>
            <section>
              <pre>
- name: Clear cache (Drupal 7)
  shell: "drush cc all"
  args:
    chdir: "{{ web_dir }}"
              </pre>
              <pre class="fragment">
- name: Clear rebuild (Drupal 8)
  shell: "drush cr all"
  args:
    chdir: "{{ web_dir }}"
              </pre>
            </section>
        </section>

<!-- CI section may be last, not first -->
        <section>
          <section>
            <h1>Getting CI</h1>
          </section>
          <section>
            <h2>Travis CI</h2>
            <p>Included for free on Github!</p>
            <p>Public repos only, some limitations</p>
          </section>
          <section>
            <h2>Self-hosted, OSS CIs</h2>
            <p>Jenkins</p>
            <p>Circle CI</p>
          </section>
          <section>
            <h2>Gitlab Runner</h2>
            <p>Included with Gitlab CE</p>
            <p>Native integration with Gitlab</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Keys and credientials?</h1>
          </section>
        </section>

        <section>
          <section>
            <h1>Takeaways</h1>
          </section>
        </section>

        <section>
          <section>
            <h1>Special thanks</h1>
            <p class="fragment">Drupal Association</p>
						<p class="fragment">TEN7</p>
            <p class="fragment">Jeff Geerling</p>
            <p class="fragment">and others</p>
          </section>

          <section>
            <h2>FRIDAY SPRINTS</h2>
          </section>

          <section>
            <h1>Thank you!</h1>
            <p>FEEDBACK LINK HERE</p>
            <p>socketwench.github.io/avoidDeepHurting</p>
          </section>
        </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
        history: true,
        controls: false,
        progress: true,
        center: true,
        width: 1024,
        height: 763,
        transition: 'slide',

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
