<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Avoid Deep Hurting! Deployment beyond git</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/cowsay.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <section>
            <h1>Avoid</h1>
            <h1 class="deep-hurting">DEEP HURTING!</h1>
            <p>Deployments beyond git</p>
            <p>&nbsp;</p>
            <small>use &larr;&uarr;&darr;&rarr; or &lt;SPACE&gt;</small>
          </section>
        </section>

        <section>
          <h2>"Where's the links?"</h2>
          <p>socketwench.github.io/avoidDeepHurting</p>
          <small>Yeah, it's case sensitive</small>
        </section>

				<section>
          <section data-transition="none">
            <img src="images/socketwench1.png" />
          </section>
          <section data-transition="none">
            <img src="images/socketwench2.png" />
          </section>
          <section data-transition="none">
            <img src="images/socketwench3.png" />
          </section>
					<section data-transition="none">
            <img src="images/socketwench4.png" />
          </section>
					<section data-transition="none">
            <img src="images/socketwench5.png" />
          </section>
          <section data-background="images/teamten7.jpeg" class="teamten7">
            <img src="images/TEN7-logo.png" />
            <p>Full service web firm</p>
            <p>Drupal, design, UX, hosting</p>
            <p><a href="mailto:hi@ten7.com">hi@ten7.com</a></p>
          </section>
        </section>

        <section>
          <section>
            <h1>Deploying Drupal</h1>
            <h2>A history</h2>
          </section>
          <section>
            <h2>Remember...</h2>
            <p class="fragment">FTP&gt; <span class="blink_me">&block;</span></p>
          </section>
          <section>
            <h2>FTP frustrations</h2>
            <p class="fragment">Insecure!</p>
            <p class="fragment">Permissions and modes</p>
            <p class="fragment">Often the only option available</p>
          </section>
          <section>
            <h2>And then git came along...</h2>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/justPullAndDone1.png" data-background-size="contain">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p class="fragment"><code>cd /where/my/awesome/site/is</code></p>
            <p class="fragment"><code>git pull</code></p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/justPullAndDone2.png" data-background-size="contain">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/awesome/site/is</code></p>
            <p><code>git pull</code></p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/justPullAndDone3.png" data-background-size="contain">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/awesome/site/is</code></p>
            <p><code>git pull</code></p>
          </section>
          <section>
            <h2>Post-pull tasks</h2>
            <p class="fragment">Updating the database</p>
            <p class="fragment">Cache clear</p>
            <p class="fragment">Done via web UI, but not recommended</p>
          </section>
          <section>
            <img src="images/andIfItStayedThatWay.png" />
          </section>
          <section style="text-align: left;">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/drupal/8/site/is</code></p>
            <p><code>git pull</code></p>
            <p class="fragment"><code>composer update</code></p>
            <p class="fragment"><code>drush cim -y</code></p>
            <p class="fragment"><code>compass compile -e production --force</code></p>
            <p class="fragment"><code>drush updb -y</code></p>
            <p class="fragment"><code>drush cr all</code></p>
          </section>
          <section>
            <img src="images/writeAllThisDown.png" />
          </section>
          <section>
            <h2>What about...?</h2>
            <p class="fragment">Grunt/Gulp tasks</p>
            <p class="fragment">Third party integrations</p>
            <p class="fragment">Clearing opcache</p>
            <p class="fragment">Varnish ban</p>
          </section>
          <section data-transition="none">
            <img src="images/badDeploy1.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy2.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy3.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy4.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy5.png" />
          </section>
          <section>
            <h2>What can go wrong?</h2>
            <p class="fragment">Missed deployment steps</p>
            <p class="fragment">Forgot to .gitignore</p>
            <p class="fragment"><code>chmod -R 777 all/the/things</code></p>
            <p class="fragment">Need to rollback!</p>
          </section>
          <section data-background="images/deepHurting.gif" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>Humans are fallible</h2>
            <p class="fragment">Good docs don't remove human hands</p>
            <p class="fragment">Typos, missed steps can kill a deploy</p>
          </section>
          <section>
            <h2>Git alone isn't enough</h2>
            <p class="fragment">It's a code history tool...</p>
            <p class="fragment">...not a deployment tool</p>
          </section>
        </section>

        <section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble1.png" data-background-size="contain">
            <h1>So let's use a script!</h1>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble3.png" data-background-size="contain">
            <h2>Solves <em>some</em> problems</h2>
            <p class="fragment">Just run the script, and your done!</p>
            <p class="fragment">...right?</p>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble4.png" data-background-size="contain">
            <h2>Reduces operator errors</h2>
            <p class="fragment">Runs all steps the same each time</p>
            <small class="fragment">(Kinda.)</small>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble5.png" data-background-size="contain">
            <h2>Writing scripts is painful</h2>
            <p class="fragment">Obscure UNIXisms</p>
            <p class="fragment">Odd programming conventions</p>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble6.png" data-background-size="contain">
            <h2>Repeatability adds complexity</h2>
            <p class="fragment">Need to check state first</p>
            <p class="fragment">Litters scripts with <code>if</code>s and <code>elsif</code>s</p>
            <p>&nbsp;</p>
          </section>
          <section data-background="images/tribbles.gif" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/aTribbleAndATribble7.png" data-background-size="contain">
            <h2>Scripts are tribbles</h2>
            <p class="fragment">They start small...</p>
            <p class="fragment">...but quickly become a big problem.</p>
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/aTribbleAndATribble8.png" data-background-size="contain">
            <h2>Scripts are tribbles</h2>
            <p>They start small...</p>
            <p>...but quickly become a big problem.</p>
            <p>&nbsp;</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Config Management</h1>
          </section>
          <!-- Some kind of comic here, probably. -->
          <section data-background-transition="none" data-background="images/whatIsAnsibleReally1.png" data-background-size="contain">
            <h2>Ansible</h2>
            <p>"Radically simple" IT Automation</p>
            <p>Open Source on <a href="https://github.com/ansible/ansible">Github</a></p>
          </section>
          <section data-background-transition="none" data-background="images/whatIsAnsibleReally2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/whatIsAnsibleReally3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess1.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess2.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess3.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess4.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess5.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess6.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess7.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess8.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess9.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess10.png" />
          </section>
          <section data-background="images/anyKindOfGemAnyKindOfSnake.png" data-background-size="contain">
            <h2>Less dependencies</h2>
            <p>Python 2</p>
            <p>Works on (most) shared hosts</p>
          </section>
          <section>
            <h2>Installation</h2>
            <p><code>apt-get install ansible</code></p>
            <p class="fragment"><code>brew install ansible</code></p>
            <p class="fragment"><code>pip install ansible</code></p>
          </section>
          <section>
            <h2>Python MySQL</h2>
            <code>pip install MySQL-python</code>
            <p>Needed for Ansible to work with DBs</p>
          </section>
          <section>
            <h2>Agentless</h2>
            <p class="fragment">Nothing to install on target systems</p>
            <p class="fragment">Uses SSH and Public Keys</p>
            <p class="fragment"><a href="https://www.linode.com/docs/security/use-public-key-authentication-with-ssh">Tutorial on Linode docs</a></p>
          </section>
          <section>
            <h2>Serverless</h2>
            <p class="fragment">No central puppetmaster server</p>
            <p class="fragment">Whatever runs ansible is the controller</p>
          </section>
          <section>
            <img src="images/inventory.png" />
            <p class="fragment">Specifies targets to manage</p>
            <p class="fragment">Text file of IPs/Hostnames</p>
            <p class="fragment">Global inventory: <code>/etc/ansible/hosts</code></p>
          </section>
          <section>
<pre><code class="ini">172.52.52.0
172.52.52.1
172.52.52.2
</code></pre><pre class="fragment"><code>
[live]
www.example.com
</code></pre><pre class="fragment"><code>
[self]
localhost ansible_connection=local</code></pre>
          </section>
          <section>
            <h2>Easy to read</h2>
            <p class="fragment">Code is YAML <em>playbooks</em></p>
            <p class="fragment">Run top-down, no complex server model</p>
          </section>
          <section>
<pre><code class="yaml">---
- hosts: all  # Target all systems!</code></pre><pre class="fragment"><code class="yaml">
  vars:
    heyLook: "A variable!"</code></pre><pre class="fragment"><code class="yaml">
  tasks:
    - name: Make some stuff happen
      stuffDoer:
        param: "{{ heyLook }}"</code></pre>
          </section>
          <section>
            <h2>Batteries included</h2>
            <p class="fragment">Modules provide functionality</p>
            <p class="fragment">No downloading, all built in.</p>
            <p class="fragment"><a href="http://docs.ansible.com/ansible/list_of_all_modules.html">http://docs.ansible.com/</a></p>
          </section>
          <section>
<pre><code class="yaml">---
- hosts: all
  vars:
    git_dir: "/home/tess/git"
  tasks:
    - name: Clone repo
      git:
        repo: git@example.com:gimmeMahStuff.git
        dest: "{{ git_dir }}"
        clone: yes
        update: yes
        version: "develop"</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/whatIfIDoneWantTOTargetGlobal1.png" data-background-size="contain">
            <h2>Running playbooks</h2>
            <p class="fragment"><code>ansible-playbook path/to/play.yml</code></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/whatIfIDoneWantTOTargetGlobal2.png" data-background-size="contain">
            <h2>Running playbooks</h2>
            <p><code>ansible-playbook path/to/play.yml</code></p>
          </section>
          <section>
            <h2>Narrowing targets</h2>
            <p class="fragment">Update playbook <code>hosts</code> to group name</p>
            <p class="fragment">Use <code>-i path/to/inventory</code></p>
          </section>
          <section data-transition="none">
            <img src="images/ansibleDirs1.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleDirs2.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleDirs3.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleDirs4.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleDirs5.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleDirs6.png" />
          </section>
        </section>

        <section>
          <section data-background-transition="none" data-background="images/fixingGitDeploy1.png" data-background-size="contain">
            <h1>Fixing git deploy</h1>
          </section>
          <section data-background-transition="none" data-background="images/fixingGitDeploy2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/fixingGitDeploy3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/fixingGitDeploy4.png" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>Git deploy is like hook_menu()</h2>
            <p class="fragment">It should do one thing well...</p>
            <p class="fragment">...not several things okay.</p>
          </section>
           <section data-transition="none">
             <img src="images/threeDirectories1.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories2.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories3.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories4.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories5.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories6.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories7.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories8.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories9.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories10.png" />
           </section>
           <section>
             <h2>No more .gitignore hell</h2>
             <p class="fragment">Git directory only mirrors the repo</p>
             <p class="fragment">No more <code>git clean -df</code></p>
           </section>
           <section>
             <h2>Ready before Go-live</h2>
             <p class="fragment"><em>Artefacts</em> created before switchover</p>
             <p class="fragment">Generated assets, compiled SASS, etc.</p>
           </section>
           <section>
             <h2>"Zero" downtime</h2>
             <p class="fragment">Directory move is fast &amp; last</p>
             <p class="fragment">Build failures won't break live</p>
           </section>
           <section>
             <pre><code class="yaml">
- name: Assure the build directory exists.
  file:
    path: "{{ build_dir }}"
    state: directory
    mode: "0755"
    group: "www-data"</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/trailingSlash1.png" data-background-size="contain">
            <pre><code class="yaml">
- name: Copy web files from the repo.
  synchronize:
    src: "{{ git_dir }}/docroot/"
    dest: "{{ build_dir }}"
    delete: yes</code></pre>
           </section>
           <section data-transition="none" data-background-transition="none" data-background="images/trailingSlash2.png" data-background-size="contain">
             <pre><code class="yaml">
- name: Copy web files from the repo.
  synchronize:
    src: "{{ git_dir }}/docroot/"
    dest: "{{ build_dir }}"
    delete: yes</code></pre>
            </section>
           <section>
<pre><code class="yaml">- name: Out with the old...
  shell: "mv {{ web_dir }} {{ web_dir }}_old"
  args:
    creates: "{{ web_dir }}_old"
    removes: "{{ web_dir }}"
</code></pre><pre class="fragment"><code class="yaml">
- name: ...in with the new.
  shell: "mv {{ build_dir }} {{ web_dir }}"
  args:
    creates: "{{ web_dir }}"
    removes: "{{ build_dir }}"</code></pre>
            </section>
            <section data-transition="none">
              <img src="images/wheresTheFileDir1.png" />
            </section>
            <section data-transition="none">
              <img src="images/wheresTheFileDir2.png" />
            </section>
            <section data-transition="none">
              <img src="images/wheresTheFileDir3.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink1.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink2.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink3.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink4.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink5.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink6.png" />
            </section>
            <section data-transition="none">
              <img src="images/filesSymlink7.png" />
            </section>
            <section>
              <pre><code class="yaml">
- name: Symlink the files dir.
  file:
    src: "{{ files_dir }}"
    dest: "{{ build_dir }}/sites/default/files"
    state: link
    mode: "0755"
    group: "www-data"

# Continue building the site. </code></pre>
            </section>
            <section>
              <h2>Post Go-live Tasks</h2>
              <p class="fragment">Config Sync import</p>
              <p class="fragment">Database update</p>
              <p class="fragment">Cache rebuild</p>
            </section>
            <section data-transition="none" data-background-transition="none" data-background="images/postGoLiveTasks1.png" data-background-size="contain">
<pre><code class="yaml">- name: Config sync import
  shell: "drush cim -y"
  args:
    chdir: "{{ web_dir }}"
- name: Update database
  shell: "drush updb -y"
  args:
    chdir: "{{ web_dir }}"
- name: Clear rebuild
  shell: "drush cr all"
  args:
    chdir: "{{ web_dir }}"</code></pre>
            </section>
            <section data-transition="none" data-background-transition="none" data-background="images/postGoLiveTasks2.png" data-background-size="contain">
<pre><code class="yaml">- name: Config sync import
  shell: "drush cim -y"
  args:
    chdir: "{{ web_dir }}"
- name: Update database
  shell: "drush updb -y"
  args:
    chdir: "{{ web_dir }}"
- name: Clear rebuild
  shell: "drush cr all"
  args:
    chdir: "{{ web_dir }}"</code></pre>
            </section>
            <section data-transition="none">
              <h2>Creating a restore point</h2>
              <p class="fragment">Keep the last site build</p>
              <p>&nbsp;</p>
              <p>&nbsp;</p>
            </section>
            <section data-transition="none">
              <h2>Creating a restore point</h2>
              <p><strike>Keep the last site build</strike></p>
              <p class="fragment">Archive <code>sync</code> directory</p>
              <p class="fragment">Create database dump</p>
            </section>
            <section>
<pre><code class="yaml"># start of the deploy

- name: Generate a timestamp
  set_fact:
    timestamp: "{{ lookup('pipe', 'date -I') }}"

</code></pre><pre class="fragment"><code class="yaml">- name: Config sync backup
  archive:
    src: "{{ sync_dir }}"
    dest: "{{ backup_dir }}/sync_{{ timestamp }}.tgz"</code></pre>
            </section>
            <section>
              <pre><code class="yaml">- name: backup database
  mysql_db:
    state: dump
    name: "{{ db_name }}"
    target: "{{ backup_dir }}/db_{{ timestamp }}.tgz"
    login_host: "{{ db_host }}"
    login_port: "{{ db_port | int }}"
    login_user: "{{ db_user }}"
    login_password: "{{ db_password }}"

# Rest of the deploy</code></pre>
            </section>
            <section data-transition="none">
              <img src="images/cantIBeLazy1.png" />
            </section>
            <section data-transition="none">
              <img src="images/cantIBeLazy2.png" />
            </section>
        </section>

        <section>
          <section>
            <h1>I want to be lazy</h1>
          </section>
          <section data-transition="none">
            <img src="images/slackOps1.png" />
          </section>
          <section data-transition="none">
            <img src="images/slackOps2.png" />
          </section>
          <section data-transition="none">
            <img src="images/slackOps3.png" />
          </section>
          <section data-transition="none">
            <img src="images/slackOps4.png" />
          </section>
          <section data-transition="none">
            <img src="images/slackOps5.png" />
          </section>
          <section data-transition="none">
            <img src="images/slackOps6.png" />
          </section>
          <section data-transition="none">
            <h2>Slack to Deploy</h2>
            <p class="fragment">Bottlenecks testing/releasing code</p>
            <p class="fragment">Makes ops a never-ending firefight</p>
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/jobDescription.png" data-background-size="contain">
            <h2>Slack to Deploy</h2>
            <p>Bottlenecks testing/releasing code</p>
            <p>Makes ops a never-ending firefight</p>
            <p>&nbsp;</p>
          </section>
          <section>
            <h2>Continuous Integration (CI)</h2>
            <p class="fragment">Commit smaller pieces every day.</p>
            <p class="fragment">Deploy as often as possible.</p>
          </section>
          <section>
            <img src="images/ciOnlyWorksWithAuto.png" />
          </section>
          <section>
            <h2>CI Servers</h2>
            <p class="fragment">Monitors your repo for events</p>
            <p class="fragment">Performs actions in response to events</p>
          </section>
          <section data-transition="none">
            <img src="images/ciProcess1.png" />
          </section>
          <section data-transition="none">
            <img src="images/ciProcess2.png" />
          </section>
          <section data-transition="none">
            <img src="images/ciProcess3.png" />
          </section>
          <section data-transition="none">
            <img src="images/ciProcess4.png" />
          </section>
          <section data-transition="none">
            <img src="images/ciProcess5.png" />
          </section>
          <section data-transition="none">
            <img src="images/ciProcess6.png" />
          </section>
          <section>
            <h2>Gitlab CI</h2>
            <p class="fragment">Integrated with Gitlab CE</p>
            <p class="fragment">Free and OSS</p>
          </section>
          <section>
            <h2>Getting Gitlab</h2>
            <p class="fragment"><a href="https://about.gitlab.com/products/">Gitlab.com free tier</a></p>
            <p class="fragment"><a href="https://about.gitlab.com/downloads/">Download &amp; Self host</a></p>
            <p class="fragment"><a href="https://docs.gitlab.com/omnibus/docker/README.html">Gitlab on Docker</a></p>
          </section>
          <section>
            <pre><code>gitlab:
  image: 'gitlab/gitlab-ce:latest'
  environment:
    GITLAB_OMNIBUS_CONFIG: |
      external_url 'http://socketwen.ch'
  ports:
    - '80:80'
    - '443:443'
    - '22:22'
  volumes:
    - '/srv/gitlab/config:/etc/gitlab'
    - '/srv/gitlab/logs:/var/log/gitlab'
    - '/srv/gitlab/data:/var/opt/gitlab'
runner:
  image: gitlab/gitlab-runner:alpine-v1.8.6
  volumes:
    - '/srv/gitlab-runner/config:/etc/gitlab-runner'
</code></pre>
          </section>
          <section data-transition="none">
            <img src="images/gettingCIToTalkToServers1.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingCIToTalkToServers2.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingCIToTalkToServers3.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingCIToTalkToServers4.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingCIToTalkToServers5.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingCIToTalkToServers6.png" />
          </section>
          <section>
            <img src="images/gitlab-ci-yml.png" />
            <p class="fragment">Maps a repository event...</p>
            <p class="fragment">...to a series of steps to execute</p>
          </section>
          <section data-transition="none">
            <pre><code class="yaml" style="font-size: 0.9em;">stages:
  - deploy

job_live_deploy:
  tags:
    - live
  stage: deploy
  script:
    - "ansible-playbook -i inventories/live live.yml"
  only:
    - master









</code></pre>
          </section>
          <section data-transition="none">
            <pre><code class="yaml" style="font-size: 0.9em;">stages:
  - deploy

job_live_deploy:
  tags:
    - live
  stage: deploy
  script:
    - "ansible-playbook -i inventories/live live.yml"
  only:
    - master

job_stage_deploy:
  tags:
    - stage
  stage: deploy
  script:
    - "ansible-playbook -i inventories/stage stage.yml"
  only:
    - develop</code></pre>
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat1.png" />
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat2.png" />
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat3.png" />
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat4.png" />
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat5.png" />
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat6.png" />
          </section>
          <section data-transition="none">
            <img src="images/whenAndWhat7.png" />
          </section>
          <section>
            <img src="images/runners.png" />
            <p class="fragment">Process that executes builds</p>
            <p class="fragment">Typically created for a specific project</p>
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess1.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess2.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess3.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess4.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess5.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess6.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess7.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess8.png" />
          </section>
          <section data-transition="none">
            <img src="images/runnerProcess9.png" />
          </section>
          <section>
            <pre><code>gitlab-runner register --non-interactive \
  --url "http://socketwen.ch" \
  --registration-token YOUR_GITLAB_TOKEN \
  --name "RUNNER_NAME" \
  --tag-list live \
  --executor ssh \
  --ssh-host PROJECT_SSH_HOST \
  --ssh-port 22 \
  --ssh-user PROJECT_SSH_USER \
  --ssh-password PROJECT_SSH_PASSWORD</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/bestForShared1.png" data-background-size="contain">
            <h2>Methods</h2>
            <p class="fragment">Runner to web server, ansible runs locally</p>
            <p class="fragment">Runner to CI server, ansible runs remotely</p>
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/bestForShared2.png" data-background-size="contain">
            <h2>Methods</h2>
            <p>Runner to web server, ansible runs locally</p>
            <p>Runner to CI server, ansible runs remotely</p>
            <p>&nbsp;</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Keys and credentials?</h1>
          </section>
          <section data-transition="none">
            <img src="images/forgotAboutTheDB1.png" />
          </section>
          <section data-transition="none">
            <img src="images/forgotAboutTheDB2.png" />
          </section>
          <section data-transition="none">
            <img src="images/forgotAboutTheDB3.png" />
          </section>
          <section data-transition="none">
            <img src="images/forgotAboutTheDB4.png" />
          </section>
          <section data-transition="none">
            <img src="images/forgotAboutTheDB5.png" />
          </section>
          <section>
            <h2>Old axiom holds true</h2>
            <p class="fragment">Never put your DB login in the repo!</p>
          </section>
          <section>
            <h2>Other stuff to keep out</h2>
            <p class="fragment">API keys</p>
            <p class="fragment">Cloud identity keys (IAM)</p>
            <p class="fragment">Hash salts<span class="fragment">?</span></p>
          </section>
          <section data-transition="none">
            <img src="images/whatsThePointOfCI1.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThePointOfCI2.png" />
          </section>
          <section>
            <h2>Gitlab secure variables</h2>
            <p class="fragment">Unique per-repository</p>
            <p class="fragment">Stored encrypted on Gitlab server</p>
            <p class="fragment">Easy to define and edit</p>
          </section>
          <section>
            <h2>Getting it to Ansible</h2>
            <p class="fragment">Exposed as environment variables</p>
            <p class="fragment">Use to set your ansible variable</p>
          </section>
          <section>
<pre><code class="yaml">---
env_name: "live"
base_dir: "/virtual/sites/example.com"
git_dir: "{{ base_dir }}/git"
build_dir: "{{ base_dir }}/wip"
web_dir: "{{ base_dir }}/src"
</code></pre><pre class="fragment"><code class="yaml">
db_user: "{{ lookup('env', 'LIVE_DB_USER') }}"
db_pass: "{{ lookup('env', 'LIVE_DB_PASS') }}"
db_name: "{{ lookup('env', 'LIVE_DB_NAME') }}"
db_host: "{{ lookup('env', 'LIVE_DB_HOST') }}"
db_port: "{{ lookup('env', 'LIVE_DB_PORT') }}"</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/envVarsInsecure.png" data-background-size="contain">
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/notPersistent1.png" data-background-size="contain">
            <h2>Gitlab CI env vars</h2>
            <p class="fragment">Only set during the build</p>
            <p class="fragment">Only for build's shell session</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/notPersistent2.png" data-background-size="contain">
            <h2>Gitlab CI env vars</h2>
            <p>Only set during the build</p>
            <p>Only for build's shell session</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/whatAboutSettingsPhp1.png" data-background-size="contain">
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/whatAboutSettingsPhp2.png" data-background-size="contain">
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/whatAboutSettingsPhp3.png" data-background-size="contain">
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/writeThemDuringTheBuild1.png" data-background-size="contain">
            <pre><code class="php">
$databases['default']['default'] = array(
  'database' => 'live_drupal8',
  'username' => 'drupal',
  'password' => 'h0rs3App|3z_!',
  'host' => 'mydb15.example.com',
  'port' => '',
  'driver' => 'mysql',
  'prefix' => '',
);
            </code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/writeThemDuringTheBuild2.png" data-background-size="contain">
            <pre><code class="php">
$databases['default']['default'] = array(
  'database' => 'live_drupal8',
  'username' => 'drupal',
  'password' => 'h0rs3App|3z_!',
  'host' => 'mydb15.example.com',
  'port' => '',
  'driver' => 'mysql',
  'prefix' => '',
);
            </code></pre>
          </section>
          <section>
            <h2>Ansible Templates</h2>
            <p class="fragment">Replace placeholders with ansible vars</p>
            <p class="fragment">Twig-like syntax</p>
          </section>
          <section>
<pre><code class="yaml">- name: Update settings file.
  template:
    src: "{{ build_dir }}/sites/default/settings.php"
    dest: "{{ build_dir }}/sites/default/settings.php"
    mode: "0755"</code></pre>
          </section>
          <section>
            <pre><code class="php">
$databases['default']['default'] = array(
  'database' => '{{ db_name }}',
  'username' => '{{ db_user }}',
  'password' => '{{ db_pass }}',
  'host' => '{{ db_host | default('127.0.0.1') }}',
  'port' => '{{ db_port | default('3306') }}',
  'driver' => 'mysql',
  'prefix' => '',
);
            </code></pre>
          </section>
          <section data-transition="none">
            <img src="images/envSettings1.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings2.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings3.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings4.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings5.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings6.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings7.png" />
          </section>
          <section data-transition="none">
            <img src="images/envSettings8.png" />
          </section>
          <section>
            <h2>Updating settings.php</h2>
            <p class="fragment">Break up into per-env files</p>
            <p class="fragment">Conditionally <code>include</code> file</p>
          </section>
          <section data-transition="none">
            <pre><code class="php">
if (file_exists(__DIR__ . '/settings.local.php')) {
  include __DIR__ . '/settings.local.php';
}









</code></pre>
          </section>
          <section data-transition="none">
            <pre><code class="php">
if (file_exists(__DIR__ . '/settings.local.php')) {
  include __DIR__ . '/settings.local.php';
}
elseif (strpos(__FILE__, '/stage/')) {
  include dirname(__FILE__) . '/settings.stage.php';
}
elseif (strpos(__FILE__, '/live/')) {
  include dirname(__FILE__) . '/settings.live.php';
}
else {
  die ('No settings.*.php file for environment!');
}</code></pre>
          </section>
          <section>
            <pre><code class="yaml">
- name: Create settings.ENVIRONMENT.php
  template:
    src: "{{ git_dir }}/sites/default/settings.{{ env_name }}.php"
    dest: "{{ build_dir }}/sites/default/settings.{{ env_name }}.php"
    mode: "0755"</code></pre>
            <small class="fragment">(Scroll right.)</small>
          </section>
        </section>

        <section>
          <section>
            <h1>Multi-project CI</h1>
          </section>
          <section data-transition="none">
            <img src="images/similarPlaybooks1.png" />
          </section>
          <section data-transition="none">
            <img src="images/similarPlaybooks2.png" />
          </section>
          <section data-transition="none">
            <img src="images/similarPlaybooks3.png" />
          </section>
          <section data-transition="none">
            <img src="images/similarPlaybooks4.png" />
          </section>
          <section data-transition="none">
            <img src="images/similarPlaybooks5.png" />
          </section>
          <section>
            <h2>Ansible Roles</h2>
            <p class="fragment">Reusable, parameterized, config sets</p>
            <p class="fragment">Packages up playbooks &amp; var defaults</p>
            <p class="fragment"><a href="http://docs.ansible.com/ansible/playbooks_roles.html#roles">Roles on Ansible Docs</a></p>
          </section>
          <section data-transition="none">
            <img src="images/copyPastedRoles1.png" />
          </section>
          <section data-transition="none">
            <img src="images/copyPastedRoles2.png" />
          </section>
          <section data-transition="none">
            <img src="images/copyPastedRoles3.png" />
          </section>
          <section data-transition="none">
            <img src="images/copyPastedRoles4.png" />
          </section>
          <section data-transition="none">
            <img src="images/copyPastedRoles5.png" />
          </section>
          <section>
            <img src="images/ansibleGalaxy.png" />
            <p class="fragment">Distribution for Ansible Roles</p>
            <p class="fragment"><a href="https://galaxy.ansible.com/">galaxy.ansible.com</a></p>
          </section>
          <section>
            <h2>Getting Roles from Galaxy</h2>
            <p class="fragment"><code>ansible-galaxy install</code></p>
            <p class="fragment">Takes one or more <em><code>org.RoleNames</code></em></p>
          </section>
          <section>
            <h2>Roles for Drupal CI</h2>
            <p class="fragment"><a href="https://galaxy.ansible.com/ten7/drupal-backup/">ten7.drupal-backup</a></p>
            <p class="fragment"><a href="https://galaxy.ansible.com/ten7/drupal-deploy/">ten7.drupal-deploy</a></p>
            <p class="fragment">Source on <a href="https://github.com/ten7">Github</a></p>
          </section>
          <section>
            <img src="images/requirements-yml.png" />
            <p class="fragment">List of roles to install</p>
            <p class="fragment">From Galaxy or a git repo</p>
          </section>
          <section>
            <pre><code class="yaml">---
- src: ten7.drupal-backup
- src: ten7.drupal-deploy</code></pre>
          </section>
          <section data-transition="none">
            <pre><code class="yaml">stages:
  - deploy

job_live_deploy:
  tags:
    - live
  stage: deploy
  script:
    - "ansible-galaxy install -fr requirements.yml --ignore-errors"
    - "ansible-playbook -i inventories/live live.yml"
  only:
    - master
</code></pre>
            <small class="fragment">(Scroll right.)</small>
          </section>
          <section>
            <pre><code class="sh">ansible-galaxy install \  # Install from Galaxy</code></pre>
            <pre class="fragment"><code class="sh">  -f \                    # Download each time</code></pre>
            <pre class="fragment"><code class="sh">  -r requirements.yml \   # Use a reqs file</code></pre>
            <pre class="fragment"><code class="sh">  --ignore-errors         # Skip if github is down</code></pre>
          </section>
          <section>
            <img src="images/happyOpsPerson.png" />
          </section>
        </section>

        <section>
          <section>
            <h2>More things to try</h2>
            <p class="fragment">Group vars for cleaner playbooks</p>
            <p class="fragment">Ansible <code>cron</code> module</p>
            <p class="fragment">Offsite backup with <a href="https://galaxy.ansible.com/ten7/tractorbeam/">ten7.tractorbeam</a></p>
          </section>
          <section>
            <h2>Things to read</h2>
            <p class="fragment"><em>Continuous Integration</em> by Duvall <em>et al</em></p>
            <p class="fragment"><em><a href="https://www.ansiblefordevops.com/">Ansible for DevOps</a></em> by Jeff Geerling</p>
            <p class="fragment"><a href="http://docs.ansible.com/ansible/index.html">docs.ansible.com</a></p>
          </section>
          <section>
            <h2>Special thanks</h2>
            <p class="fragment">Twin Cities Drupal</p>
						<p class="fragment">TEN7</p>
            <p class="fragment"><a href="https://www.patreon.com/socketwench">patreon.com/socketwench</a></p>
          </section>

          <section>
            <h2>Sunday Sprints @ ICF Olson!</h2>
            <p class="fragment">9:30-5, address on page 13</p>
            <p class="fragment">Help from mentors all day!</p>
          </section>

          <section data-background-transition="none" data-background="images/thankyou.png" data-background-size="contain">
            <h1>Thank you!</h1>
            <p>Feedback @ <a href="https://joind.in/talk/9f8bd">joind.in/talk/9f8bd</a></p>
            <p>socketwench.github.io/avoidDeepHurting</p>
            <p>&nbsp;</p>
          </section>
        </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
        history: true,
        controls: false,
        progress: true,
        center: true,
        width: 1024,
        height: 763,
        transition: 'slide',

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
