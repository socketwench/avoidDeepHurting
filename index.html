<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Avoid Deep Hurting! Deployment beyond git</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/cowsay.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <section>
            <h1>Avoid</h1>
            <h1 class="deep-hurting">DEEP HURTING!</h1>
            <p>Deployments beyond git</p>
            <p>&nbsp;</p>
            <small>use &larr;&uarr;&darr;&rarr; or &lt;SPACE&gt;</small>
          </section>
          <section>
            <pre style="font-size:1em;">
      _________________
    /                   \
    |  Time to deploy!  |
    \                   /
      -----------------
             \   ^__^
              \  (oo)\_______
                 (__)\       )\/\
                     ||----w |
                     ||     ||
            </pre>
          </section>
        </section>

				<section>
          <section data-transition="none">
            <img src="images/socketwench1.png" />
          </section>
          <section data-transition="none">
            <img src="images/socketwench2.png" />
          </section>
          <section data-transition="none">
            <img src="images/socketwench3.png" />
          </section>
					<section data-transition="none">
            <img src="images/socketwench4.png" />
          </section>
					<section data-transition="none">
            <img src="images/socketwench5.png" />
          </section>
          <section>
            <p>TEN7 marketing slide</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Deploying Drupal</h1>
            <h2>A history</h2>
          </section>
          <section>
            <h2>Remember...</h2>
            <p class="fragment">FTP&gt; <span class="blink_me">&block;</span></p>
          </section>
          <section>
            <h2>FTP frustrations</h2>
            <p class="fragment">Insecure!</p>
            <p class="fragment">Permissions and modes</p>
            <p class="fragment">Often the only option available</p>
          </section>
          <section>
            <h2>And then git came along...</h2>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/justPullAndDone1.png" data-background-size="contain">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p class="fragment"><code>cd /where/my/awesome/site/is</code></p>
            <p class="fragment"><code>git pull</code></p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/justPullAndDone2.png" data-background-size="contain">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/awesome/site/is</code></p>
            <p><code>git pull</code></p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/justPullAndDone3.png" data-background-size="contain">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/awesome/site/is</code></p>
            <p><code>git pull</code></p>
          </section>
          <section>
            <h2>Post-pull tasks</h2>
            <p class="fragment">Updating the database</p>
            <p class="fragment">Clearing rebuild</p>
            <p class="fragment">Done via web UI, but not recommended</p>
          </section>
          <section>
            <img src="images/andIfItStayedThatWay.png" />
          </section>
          <section style="text-align: left;">
            <p><code>ssh gitlover@savemefromftp.now</code></p>
            <p><code>cd /where/my/drupal/8/site/is</code></p>
            <p><code>git pull</code></p>
            <p class="fragment"><code>composer update</code></p>
            <p class="fragment"><code>drush cim -y</code></p>
            <p class="fragment"><code>compass compile -e production --force</code></p>
            <p class="fragment"><code>drush updb -y</code></p>
            <p class="fragment"><code>drush cr all</code></p>
          </section>
          <section>
            <img src="images/writeAllThisDown.png" />
          </section>
          <section>
            <h2>What about...?</h2>
            <p class="fragment">Grunt/Gulp tasks</p>
            <p class="fragment">Third party integrations</p>
            <p class="fragment">Clearing opcache</p>
            <p class="fragment">Varnish ban</p>
          </section>
          <section data-transition="none">
            <img src="images/badDeploy1.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy2.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy3.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy4.png" />
          </section>
          <section data-transition="none">
            <img src="images/badDeploy5.png" />
          </section>
          <section>
            <h2>What can go wrong?</h2>
            <p class="fragment">Missed deployment steps</p>
            <p class="fragment">Forgot to .gitignore</p>
            <p class="fragment"><code>chmod -R 777 all/the/things</code></p>
            <p class="fragment">Need to rollback!</p>
          </section>
          <section data-background="images/deepHurting.gif" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>Humans are fallible</h2>
            <p class="fragment">Good docs don't remove human hands</p>
            <p class="fragment">Typos, missed steps can kill a deploy</p>
          </section>
          <section>
            <h2>Git alone isn't enough</h2>
            <p class="fragment">It's a code history tool...</p>
            <p class="fragment">...not a deployment tool</p>
          </section>
        </section>

        <section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble1.png" data-background-size="contain">
            <h1>So let's use a script!</h1>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble3.png" data-background-size="contain">
            <h2>Solves <em>some</em> problems</h2>
            <p class="fragment">Just run the script, and your done!</p>
            <p class="fragment">...right?</p>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble4.png" data-background-size="contain">
            <h2>Reduces operator errors</h2>
            <p class="fragment">Runs all steps the same each time</p>
            <small class="fragment">(Kinda.)</small>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble5.png" data-background-size="contain">
            <h2>Writing scripts is painful</h2>
            <p class="fragment">Obscure UNIXisms</p>
            <p class="fragment">Odd programming conventions</p>
          </section>
          <section data-background-transition="none" data-background="images/aTribbleAndATribble6.png" data-background-size="contain">
            <h2>Repeatability adds complexity</h2>
            <p class="fragment">Need to check state first</p>
            <p class="fragment">Litters scripts with <code>if</code>s and <code>elsif</code>s</p>
            <p>&nbsp;</p>
          </section>
          <section data-background="images/tribbles.gif" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/aTribbleAndATribble7.png" data-background-size="contain">
            <h2>Scripts are tribbles</h2>
            <p class="fragment">They start small...</p>
            <p class="fragment">...but quickly become a big problem.</p>
            <p>&nbsp;</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/aTribbleAndATribble8.png" data-background-size="contain">
            <h2>Scripts are tribbles</h2>
            <p>They start small...</p>
            <p>...but quickly become a big problem.</p>
            <p>&nbsp;</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Config Management</h1>
          </section>
          <!-- Some kind of comic here, probably. -->
          <section data-background-transition="none" data-background="images/whatIsAnsibleReally1.png" data-background-size="contain">
            <h2>Ansible</h2>
            <p>"Radically simple" IT Automation</p>
            <p>Open Source on <a href="https://github.com/ansible/ansible">Github</a></p>
          </section>
          <section data-background-transition="none" data-background="images/whatIsAnsibleReally2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/whatIsAnsibleReally3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess1.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess2.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess3.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess4.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess5.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess6.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess7.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess8.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess9.png" />
          </section>
          <section data-transition="none">
            <img src="images/ansibleProcess10.png" />
          </section>
          <section>
            <h2>Less dependencies</h2>
            <p>Python 2</p>
            <p>Works on (most) shared hosts</p>
          </section>
          <section>
            <p><code>apt-get install ansible</code></p>
            <p class="fragment"><code>brew install ansible</code></p>
            <p class="fragment"><code>pip install ansible</code></p>
          </section>
          <section>
            <h2>Python MySQL</h2>
            <code>pip install MySQL-python</code>
            <p>Needed for Ansible to work with DBs</p>
          </section>
          <section>
            <h2>Agentless</h2>
            <p class="fragment">Nothing to install on target systems</p>
            <p class="fragment">Uses SSH and Public Keys</p>
            <p class="fragment"><a href="https://www.linode.com/docs/security/use-public-key-authentication-with-ssh">Tutorial on Linode docs</a></p>
          </section>
          <section>
            <h2>Serverless</h2>
            <p class="fragment">No central puppetmaster server</p>
            <p class="fragment">Whatever runs ansible is the controller</p>
          </section>
          <section>
            <h2>Specifying targets</h2>
            <p class="fragment">Inventory files</p>
            <p class="fragment">Text file of IPs/Hostnames</p>
          </section>
          <section>
<pre><code>172.52.52.0
172.52.52.1
172.52.52.2
</code></pre><pre class="fragment"><code>
[live]
www.example.com
</code></pre><pre class="fragment"><code>
[self]
localhost ansible_connection=local</code></pre>
          </section>
          <section>
            <h2>Easy to read</h2>
            <p class="fragment">Code is YAML <em>playbooks</em></p>
            <p class="fragment">Run top-down, no complex server model</p>
          </section>
          <section>
<pre><code>---
- hosts: all
  vars:
    heyLook: "A variable!"
  tasks:
    - name: Make some stuff happen
      stuffDoer:
        param: "{{ heyLook }}"</code></pre>
          </section>
          <section>
            <h2>Batteries included</h2>
            <p class="fragment">Modules provide functionality</p>
            <p class="fragment">All official modules included</p>
          </section>
          <section>
<pre><code>---
- hosts: all
  vars:
    git_dir: "/home/tess/git"
  tasks:
    - name: Clone repo
      git:
        repo: git@example.com:gimmeMahStuff.git
        dest: "{{ git_dir }}"
        clone: yes
        update: yes
        version: "develop"</code></pre>
          </section>
          <section>
            <h2>Idemnopent</h2>
            <p class="fragment">Playbooks describe desired end state</p>
            <p class="fragment">Leaves complex <code>if</code>/<code>else</code> logic to modules</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Fixing git deploy</h1>
          </section>
          <!-- COMIC
            Ends on realization that throwing the web directory away is the
            solution.
           -->
           <section data-transition="none">
             <img src="images/threeDirectories1.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories2.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories3.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories4.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories5.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories6.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories7.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories8.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories9.png" />
           </section>
           <section data-transition="none">
             <img src="images/threeDirectories10.png" />
           </section>
           <section>
             <h2>No more .gitignore hell</h2>
             <p>"Artefacts" no longer in repo</p>
             <p>File directory, compiled SASS, etc.</p>
           </section>
           <section>
             <h2>Ready before Go-live</h2>
             <p>Key assets created before switchover</p>
             <p>"Zero downtime" deployments</p>
           </section>
           <section>
             <pre><code>
- name: Assure the build directory exists.
  file:
    path: "{{ build_dir }}"
    state: directory
    mode: "0755"
    group: "www-data"</code></pre>
          </section>
          <section>
            <pre><code>
- name: Copy web files from the repo.
  synchronize:
    src: "{{ web_dir }}/"
    dest: "{{ build_dir }}"
    delete: yes</code></pre>
           </section>
           <section>
             <pre><code>
- name: Symlink the files directory.
  file:
    src: "{{ files_dir }}"
    dest: "{{ web_dir }}/sites/default/files"
    state: link
    mode: "0775"</code></pre>
           </section>
           <section>
<pre><code>- name: Out with the old...
  shell: "mv {{ web_dir }} {{ web_dir }}_old"
  args:
    creates: "{{ web_dir }}_old"
    removes: "{{ web_dir }}"
</code></pre><pre class="fragment"><code>
- name: ...in with the new.
  shell: "mv {{ build_dir }} {{ web_dir }}"
  args:
    creates: "{{ web_dir }}"
    removes: "{{ build_dir }}"</code></pre>
            </section>
            <section>
              <h2>Alternative: Capistrano style</h2>
              <p>Timestamp-named build directories</p>
              <p class="fragment"><code>current</code> symlink used as web directory</p>
            </section>
            <!-- COMIC? -->
            <section>
              <h2>Problems</h2>
              <p class="fragment">OpCache refresh must be forced</p>
              <p class="fragment">Autoloaders can become confused</p>
            </section>
            <section>
              <h2>Post Go-live Tasks</h2>
              <p class="fragment">Feature revert or Config Sync import</p>
              <p class="fragment">Database update</p>
              <p class="fragment">Cache clear</p>
            </section>
            <section>
<pre><code>- name: Feature revert (Drupal 7)
  shell: "drush fra -y"
  args:
    chdir: "{{ web_dir }}"</code></pre><pre class="fragment"><code>
- name: Config sync import (Drupal 8)
  shell: "drush cim -y"
  args:
    chdir: "{{ web_dir }}"</code></pre>
            </section>
            <section>
<pre><code>- name: Update database
  shell: "drush updb -y"
  args:
    chdir: "{{ web_dir }}"</code></pre>
            </section>
            <section>
<pre><code>- name: Clear cache (Drupal 7)
  shell: "drush cc all"
  args:
    chdir: "{{ web_dir }}"
</code></pre><pre class="fragment"><code>
- name: Clear rebuild (Drupal 8)
  shell: "drush cr all"
  args:
    chdir: "{{ web_dir }}"</code></pre>
            </section>
        </section>

<!-- CI section may be last, not first -->
        <section>
          <section>
            <h1>But I want to be lazy</h1>
          </section>
          <!-- COMIC
               This is great and all, but I'm still the one everyone slacks to deploy!
               Can't I just be lazy?
               Why can't the servers just do this for me?
             -->
          <section>
            <h2>CI Servers</h2>
            <p class="fragment">Monitors your repo for events</p>
            <p class="fragment">Performs actions in response to events</p>
          </section>
          <section>
            <h2>Travis CI</h2>
            <p>Included for free on Github!</p>
            <p>Public repos only, some limitations</p>
          </section>
          <section>
            <h2>Self-hosted, OSS CIs</h2>
            <p class="fragment">Jenkins</p>
            <p class="fragment">Circle CI</p>
            <p class="fragment">Many others!</p>
          </section>
          <section>
            <h2>Gitlab CI</h2>
            <p class="fragment">Integrated with Gitlab CE</p>
            <p class="fragment">Free and OSS</p>
          </section>
          <section>
            <h2>Runners</h2>
            <p class="fragment">Process that executes builds</p>
            <p class="fragment">Local or remote via SSH</p>
          </section>
          <section>
            <h2>.gitlab-ci.yml</h2>
            <p class="fragment">Gitlab CI config file</p>
            <p class="fragment">Put in the top level of your repo</p>
          </section>
          <section>
<pre><code>stages:
  - deploy

job_live_deploy:
  tags:
    - live
  stage: deploy
  script:
    - "ansible-playbook -i inventory/live live.yml"
  only:
    - master</code></pre>
          </section>
          <!-- COMIC
               Something about our directory organization
             -->
          <section>
            <h2>Environment playbooks</h2>
            <p>Allows customization per environment</p>
            <p>Different file paths, enable/disable modules, etc.</p>
          </section>
          <section>
            <h2>Inventories</h2>
            <p>One file per environment</p>
          </section>
          <section>
            <pre><code>
[live]
localhost ansible_connection=local
            </code></pre>
          </section>
          <section>
            <h2>What about shared hosts?</h2>
            <p>Ansible isn't installed</p>
            <p>CI server used as controller</p>
          </section>
          <section>
            <pre><code>
[live]
example.com ansible_user=jane
            </code></pre>
          </section>
          <section>
            <h2>Group vars</h2>
            <p>Defines variables for a host group</p>
            <p>Loaded transparently, just specfy <code>-i</code></p>
          </section>
          <section>
            <pre><code>
---
env_name: "live"
base_dir: "/virtual/sites/example.com"
git_dir: "{{ base_dir }}/git"
build_dir: "{{ base_dir }}/wip"
web_dir: "{{ base_dir }}/src"
            </code></pre>
          </section>
          <!-- Something about galaxy? -->
        </section>

        <section>
          <section>
            <h1>Keys and credientials?</h1>
          </section>
          <section>
            <h2>Old axiom holds true</h2>
            <p class="fragment">Never put your DB login in the repo!</p>
          </section>
          <section>
            <h2>Other stuff to keep out</h2>
            <p>API keys</p>
            <p>Cloud identity keys (IAM)</p>
            <p>Hash salts<span class="fragment">?</span></p>
          </section>
          <section>
            <h2>Not so secret "secrets"</h2>
            <p>Server username and group</p>
            <p>Varnish key</p>
          </section>
          <section>
            <h2>Gitlab secure variables</h2>
            <p>Unique per-repository</p>
            <p>Stored encrypted on Gitlab server</p>
            <p>Easy to define and edit</p>
          </section>
          <section>
            <h2>Getting it to Ansible</h2>
            <p>Exposed as environment variables</p>
            <p>Use to set your ansible variable</p>
          </section>
          <section data-transition=none>
<pre><code>---
env_name: "live"
base_dir: "/virtual/sites/example.com"
git_dir: "{{ base_dir }}/git"
build_dir: "{{ base_dir }}/wip"
web_dir: "{{ base_dir }}/src"






</code></pre>
          </section>
          <section data-transition="none">
<pre><code>---
env_name: "live"
base_dir: "/virtual/sites/example.com"
git_dir: "{{ base_dir }}/git"
build_dir: "{{ base_dir }}/wip"
web_dir: "{{ base_dir }}/src"

db_user: "{{ lookup('env', 'LIVE_DB_USER') }}"
db_pass: "{{ lookup('env', 'LIVE_DB_PASS') }}"
db_name: "{{ lookup('env', 'LIVE_DB_NAME') }}"
db_host: "{{ lookup('env', 'LIVE_DB_HOST') }}"
db_port: "{{ lookup('env', 'LIVE_DB_PORT') }}"</code></pre>
          </section>
          <!-- COMIC
                Whoa! By environment variables are super mega insecure!
              -->
          <section>
            <h2>Gitlab CI env vars</h2>
            <p>Only set during the build</p>
            <p>Only for build's shell session</p>
          </section>
          <section>
            <h2>Alternative: Ansible Vault</h2>
            <p>Encrypted var file</p>
            <p>Store password in text file on server</p>
            <p><a href="http://docs.ansible.com/ansible/playbooks_vault.html">Vault on docs.ansible.com</a></p>
          </section>
          <!-- COMIC
               So what about settings.php?
          -->
          <section>
            <h2>Ansible Templates</h2>
            <p>Replace placeholders with ansible vars</p>
            <p>Twig-like syntax</p>
          </section>
          <section>
            <pre><code>
$databases['default']['default'] = array(
  'database' => '{{ db_name }}',
  'username' => '{{ db_user }}',
  'password' => '{{ db_pass }}',
  'host' => '{{ db_host | default('127.0.0.1') }}',
  'port' => '{{ db_port | default('3306') }}',
  'driver' => 'mysql',
  'prefix' => '',
);
            </code></pre>
          </section>
          <!-- COMIC
              The DBs are different per environment
              but
              What about memcache? Varnish? Config overrides?
            -->
          <section>
            <h2>Updating settings.php</h2>
            <p>Break up into per-env files</p>
            <p>Conditionally <code>include</code> file</p>
          </section>
          <section data-transition="none">
            <pre><code>
if (file_exists(__DIR__ . '/settings.local.php')) {
  include __DIR__ . '/settings.local.php';
}









</code></pre>
          </section>
          <section data-transition="none">
            <pre><code>
if (file_exists(__DIR__ . '/settings.local.php')) {
  include __DIR__ . '/settings.local.php';
}
elseif (strpos(__FILE__, '/stage/')) {
  include dirname(__FILE__) . '/settings.stage.php';
}
elseif (strpos(__FILE__, '/live/')) {
  include dirname(__FILE__) . '/settings.live.php';
}
else {
  die ('No settings.*.php file for environment!');
}</code></pre>
          </section>
          <section>
            <pre><code>
- name: Create settings.ENVIRONMENT.php
  template:
    src: "{{ git_dir }}/sites/default/settings.{{ env_name }}.php"
    dest: "{{ build_dir }}/sites/default/settings.{{ env_name }}.php"
    mode: "0755"</code></pre>
            <small class="fragment">(Scroll right.)</small>
          </section>
        </section>

        <section>
          <section>
            <h1>Takeaways</h1>
          </section>
          <section>
            <h2>The Repo is the Server</h2>
            <p class="fragment">Never SSH in unless something breaks</p>
          </section>
          <section>
            <h2>Everything is in the repo*</h2>
            <p class="fragment">Use secure vars for logins and keys</p>
          </section>
          <section>
            <h2>Keep branches the same</h2>
            <p class="fragment">Separate conf files per environment</p>
          </section>
          <section>
            <h2>Make CI do everything</h2>
            <p class="fragment">Varnish ban, bounce Apache, anything needed</p>
          </section>
          <section>
            <h2>CI hurts now...</h2>
            <p class="fragment">...so it doesn't later.</p>
          </section>
        </section>

        <section>
          <section>
            <h1>Special thanks</h1>
            <p class="fragment">Drupal Association</p>
						<p class="fragment">TEN7</p>
            <p class="fragment">Jeff Geerling</p>
            <p class="fragment">and others</p>
          </section>

          <section>
            <h2>FRIDAY SPRINTS</h2>
          </section>

          <section>
            <h1>Thank you!</h1>
            <p>FEEDBACK LINK HERE</p>
            <p>socketwench.github.io/avoidDeepHurting</p>
          </section>
        </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
        history: true,
        controls: false,
        progress: true,
        center: true,
        width: 1024,
        height: 763,
        transition: 'slide',

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
